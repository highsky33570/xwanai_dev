# XWANAI å‰åç«¯è”åˆæ–‡æ¡£

> **AIé©±åŠ¨çš„ä¸­å›½å…«å­—å‘½ç†åˆ†æå¹³å° - å‰åç«¯åä½œå®Œæ•´æŒ‡å—**

**æœ€åæ›´æ–°**: 2025-11-16  
**ç‰ˆæœ¬**: 2.0.0  
**æ–‡æ¡£ä½œè€…**: XWANAI Team

---

## ğŸ“‘ ç›®å½•

- [æ¶æ„æ€»è§ˆ](#æ¶æ„æ€»è§ˆ)
- [æ•°æ®æµè®¾è®¡](#æ•°æ®æµè®¾è®¡)
- [API é›†æˆ](#api-é›†æˆ)
- [SSE èŠå¤©åè®®](#sse-èŠå¤©åè®®)
- [è®¤è¯æµç¨‹](#è®¤è¯æµç¨‹)
- [å…±äº«èµ„æº](#å…±äº«èµ„æº)
- [æ ¸å¿ƒä¸šåŠ¡æµç¨‹](#æ ¸å¿ƒä¸šåŠ¡æµç¨‹)
- [é”™è¯¯å¤„ç†](#é”™è¯¯å¤„ç†)
- [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
- [å¼€å‘åä½œ](#å¼€å‘åä½œ)

---

## ğŸ—ï¸ æ¶æ„æ€»è§ˆ

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”¨æˆ·æµè§ˆå™¨                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         Next.js 15 Frontend (Port 3000)            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ App Router Pages                              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ - (base)/database, character, user            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ - (chat)/chat/[id]                            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ - (login)/login, register                     â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ Components                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ - CharacterCard, ChatMessage, Sidebar         â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ State Management                               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ - MobX Stores (User, Session, Global)         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ - React Query (Server State)                  â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†• HTTP/HTTPS
                          â†• SSE (EventSource)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚      FastAPI Backend (Port 8000)                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ API Routes (app/api/v1/)                      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ - users, character, chat, share, stripe       â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ Services (app/services/)                      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ - CharacterService, ChatService, ...          â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ Utils                                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ - Auth, BaziCalculator, UsageLimit            â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Supabase PostgreSQL                           â”‚
â”‚  - characters, sessions, events, profiles                    â”‚
â”‚  - RPC Functions (is_premium_user, get_usage_stats)          â”‚
â”‚  - Row Level Security (RLS)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              External Services                                â”‚
â”‚  - Google Gemini AI (AI å¯¹è¯)                                â”‚
â”‚  - OpenAI (å¤‡ç”¨ AI)                                          â”‚
â”‚  - Stripe (æ”¯ä»˜å¤„ç†)                                         â”‚
â”‚  - Supabase Storage (æ–‡ä»¶å­˜å‚¨)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€æœ¯æ ˆå¯¹æ¯”

| å±‚çº§ | å‰ç«¯ | åç«¯ |
|------|------|------|
| **æ¡†æ¶** | Next.js 15 (App Router) | FastAPI |
| **è¯­è¨€** | TypeScript | Python 3.12+ |
| **æ•°æ®åº“è®¿é—®** | Supabase Client SDK | Supabase Python SDK |
| **çŠ¶æ€ç®¡ç†** | MobX + React Query | N/A |
| **è®¤è¯** | Supabase Auth (Client) | JWT éªŒè¯ |
| **AI é›†æˆ** | æ—  (é€šè¿‡åç«¯) | Gemini + OpenAI |
| **å®æ—¶é€šä¿¡** | EventSource (SSE Client) | StreamingResponse (SSE Server) |

---

## ğŸ”„ æ•°æ®æµè®¾è®¡

### 1. æ•°æ®è·å–ç­–ç•¥

**å‰ç«¯å†³ç­–æ ‘**:
```
éœ€è¦æ•°æ®ï¼Ÿ
  â†“
æ˜¯å¦éœ€è¦åç«¯å¤„ç†/AIï¼Ÿ
  â”œâ”€ æ˜¯ â†’ è°ƒç”¨åç«¯ API
  â”‚     ä¾‹: åˆ›å»ºè§’è‰²ã€ç”ŸæˆæŠ¥å‘Šã€AI å¯¹è¯
  â”‚
  â””â”€ å¦ â†’ ç›´æ¥ä½¿ç”¨ Supabase Client
        ä¾‹: æŸ¥è¯¢è§’è‰²åˆ—è¡¨ã€è·å–ç”¨æˆ·èµ„æ–™ã€æ£€æŸ¥ä¼šå‘˜çŠ¶æ€
```

**ç¤ºä¾‹å¯¹æ¯”**:

| æ“ä½œ | å‰ç«¯å®ç° | åŸå›  |
|------|----------|------|
| è·å–ç”¨æˆ·è§’è‰²åˆ—è¡¨ | Supabase Client | ç®€å•æŸ¥è¯¢ï¼Œæœ‰ RLS ä¿æŠ¤ |
| åˆ›å»ºè§’è‰² | åç«¯ API | éœ€è¦å…«å­—è®¡ç®— + é…é¢æ£€æŸ¥ |
| æ£€æŸ¥ä¼šå‘˜çŠ¶æ€ | Supabase RPC | ç®€å•é€»è¾‘ï¼ŒRPC å‡½æ•° |
| AI èŠå¤© | åç«¯ API (SSE) | éœ€è¦ AI æœåŠ¡é›†æˆ |
| ç”ŸæˆæŠ¥å‘Š | åç«¯ API | éœ€è¦ AI + å¤šæ­¥éª¤å¤„ç† |
| æ”¶è—è§’è‰² | Supabase RPC | RPC å‡½æ•°å¤„ç† |

### 2. æ•°æ®æµå‘ç¤ºä¾‹

#### åœºæ™¯1: ç”¨æˆ·æµè§ˆè§’è‰²åˆ—è¡¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·è®¿é—®   â”‚
â”‚  /database  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend (database/page.tsx)         â”‚
â”‚                                       â”‚
â”‚ 1. useEffect(() => {                 â”‚
â”‚      loadUserAndCharacters()         â”‚
â”‚    })                                 â”‚
â”‚                                       â”‚
â”‚ 2. const { data } = await supabase  â”‚
â”‚      .from('characters')             â”‚
â”‚      .select('*')                    â”‚
â”‚      .eq('auth_id', userId)          â”‚
â”‚                                       â”‚
â”‚ 3. setCharacters(data)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Supabase PostgreSQL                  â”‚
â”‚                                       â”‚
â”‚ SELECT * FROM characters             â”‚
â”‚ WHERE auth_id = 'user_uuid'          â”‚
â”‚ ORDER BY created_at DESC             â”‚
â”‚                                       â”‚
â”‚ (RLS è‡ªåŠ¨éªŒè¯ç”¨æˆ·æƒé™)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend Render                       â”‚
â”‚                                       â”‚
â”‚ {characters.map(char => (            â”‚
â”‚   <CharacterCard                     â”‚
â”‚     key={char.id}                    â”‚
â”‚     character={char}                 â”‚
â”‚   />                                 â”‚
â”‚ ))}                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### åœºæ™¯2: ç”¨æˆ·åˆ›å»ºè§’è‰²

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·å¡«å†™è¡¨å• â”‚
â”‚ + ç‚¹å‡»åˆ›å»º  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend (ModeSelectionModal)        â”‚
â”‚                                       â”‚
â”‚ 1. const response = await            â”‚
â”‚      apiClient.createCharacter({     â”‚
â”‚        name, gender, birth_time, ... â”‚
â”‚      })                               â”‚
â”‚                                       â”‚
â”‚ 2. å‘é€ POST è¯·æ±‚åˆ°åç«¯              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“ HTTP POST
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Backend (/api/character/v1)          â”‚
â”‚                                       â”‚
â”‚ 1. éªŒè¯ JWT Token                    â”‚
â”‚ 2. æ£€æŸ¥é…é¢é™åˆ¶                      â”‚
â”‚    await require_character_quota()   â”‚
â”‚                                       â”‚
â”‚ 3. è®¡ç®—å…«å­—                          â”‚
â”‚    paipan = bazi_calculator          â”‚
â”‚      .calculate_bazi(birth_time)     â”‚
â”‚                                       â”‚
â”‚ 4. ä¿å­˜åˆ°æ•°æ®åº“                      â”‚
â”‚    await client.table('characters')  â”‚
â”‚      .insert(character_data)         â”‚
â”‚                                       â”‚
â”‚ 5. åå°ä»»åŠ¡: ç”ŸæˆæŠ¥å‘Š                â”‚
â”‚    bg_task.add_task(                 â”‚
â”‚      generate_reports,               â”‚
â”‚      character_id                    â”‚
â”‚    )                                 â”‚
â”‚                                       â”‚
â”‚ 6. è¿”å›è§’è‰²æ•°æ®                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“ HTTP 200 OK
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend                              â”‚
â”‚                                       â”‚
â”‚ 1. æ¥æ”¶å“åº”                          â”‚
â”‚    const character = response.data   â”‚
â”‚                                       â”‚
â”‚ 2. åˆ·æ–° React Query ç¼“å­˜             â”‚
â”‚    queryClient.invalidateQueries({   â”‚
â”‚      queryKey: ['characters', userId]â”‚
â”‚    })                                 â”‚
â”‚                                       â”‚
â”‚ 3. è·³è½¬åˆ°è§’è‰²è¯¦æƒ…                    â”‚
â”‚    router.push(`/character/info?id=${â”‚
â”‚      character.id                    â”‚
â”‚    }`)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### åœºæ™¯3: AI èŠå¤©å¯¹è¯ (SSE)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·å‘é€æ¶ˆæ¯ â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend (chat/[id]/page.tsx)        â”‚
â”‚                                       â”‚
â”‚ 1. useChatSSE Hook                   â”‚
â”‚    sendMessage(message, mode)        â”‚
â”‚                                       â”‚
â”‚ 2. å‘é€ POST è¯·æ±‚ (Accept: SSE)      â”‚
â”‚    fetch(`${API_BASE_URL}/chat`, {   â”‚
â”‚      headers: {                      â”‚
â”‚        'Accept': 'text/event-stream' â”‚
â”‚      }                                â”‚
â”‚    })                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“ HTTP POST (SSE)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Backend (/api/chat/v1)               â”‚
â”‚                                       â”‚
â”‚ async def chat_stream_generator():   â”‚
â”‚   1. æ£€æŸ¥é…é¢é™åˆ¶                    â”‚
â”‚   2. åŠ è½½ session å’Œè§’è‰²ç¼“å­˜         â”‚
â”‚   3. æ„å»º AI Prompt                  â”‚
â”‚   4. è°ƒç”¨ Gemini AI (æµå¼)           â”‚
â”‚                                       â”‚
â”‚   # æµå¼å‘é€ thinking                â”‚
â”‚   yield f"event: thinking\n"         â”‚
â”‚   yield f"data: {{...}}\n\n"         â”‚
â”‚                                       â”‚
â”‚   # æµå¼å‘é€ AI å›å¤                 â”‚
â”‚   async for chunk in model.stream(): â”‚
â”‚     yield f"data: {{...}}\n\n"       â”‚
â”‚                                       â”‚
â”‚   # å‘é€å®Œæˆæ ‡è®°                     â”‚
â”‚   yield "data: [DONE]\n\n"           â”‚
â”‚                                       â”‚
â”‚ return StreamingResponse(            â”‚
â”‚   chat_stream_generator(),           â”‚
â”‚   media_type="text/event-stream"     â”‚
â”‚ )                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“ SSE Stream
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend (useChatSSE Hook)           â”‚
â”‚                                       â”‚
â”‚ const reader = response.body.getReader()â”‚
â”‚                                       â”‚
â”‚ while (true) {                        â”‚
â”‚   const { done, value } = await      â”‚
â”‚     reader.read()                     â”‚
â”‚                                       â”‚
â”‚   // è§£æ SSE æ•°æ®                   â”‚
â”‚   if (line.startsWith("event:")) {   â”‚
â”‚     currentEvent = line.slice(7)     â”‚
â”‚   }                                   â”‚
â”‚                                       â”‚
â”‚   if (line.startsWith("data:")) {    â”‚
â”‚     const data = JSON.parse(...)     â”‚
â”‚                                       â”‚
â”‚     // æ›´æ–° UI                       â”‚
â”‚     if (currentEvent === "thinking") â”‚
â”‚       setCurrentThinkingMessage(...)  â”‚
â”‚     else                              â”‚
â”‚       setCurrentAssistantMessage(...) â”‚
â”‚   }                                   â”‚
â”‚ }                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ UI å®æ—¶æ›´æ–°                           â”‚
â”‚                                       â”‚
â”‚ - Thinking éƒ¨åˆ†å¯æŠ˜å æ˜¾ç¤º            â”‚
â”‚ - AI å›å¤é€å­—æ˜¾ç¤º                    â”‚
â”‚ - æ‰“å­—æœºå…‰æ ‡æ•ˆæœ                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”Œ API é›†æˆ

### API åŸºç¡€é…ç½®

**å‰ç«¯é…ç½®**:
```typescript
// lib/api/config.ts
export const API_BASE_URL = process.env.NEXT_PUBLIC_API_BASE_URL || 'http://localhost:8000'

export const apiEndpoints = {
  users: {
    avatar: '/api/users/v1/avatar',
    me: '/api/users/v1/me'
  },
  character: {
    create: '/api/character/v1',
    detail: (id: string) => `/api/character/v1/${id}`,
    reports: (id: string) => `/api/character/v1/${id}/reports`
  },
  chat: {
    base: '/api/chat/v1',
    session: '/api/chat/v1/session',
    turnStats: (sessionId: string) => `/api/chat/v1/session/${sessionId}/turn-stats`
  },
  stripe: {
    checkout: '/api/stripe/v1/checkout',
    portal: '/api/stripe/v1/portal'
  }
}
```

**åç«¯é…ç½®**:
```python
# app/core/config.py
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    # API é…ç½®
    app_name: str = "XWANAI API"
    environment: str = "development"
    
    # CORS é…ç½®
    allowed_origins: list = ["http://localhost:3000", "https://xwanai.com"]
    
    # Supabase é…ç½®
    supabase_url: str
    supabase_anon_key: str
    supabase_service_role_key: str
    supabase_jwt_secret: str
    
    # AI é…ç½®
    gemini_api_key: str
    openai_api_key: str
    
    # Stripe é…ç½®
    stripe_secret_key: str
    stripe_webhook_secret: str

settings = Settings()
```

### è¯·æ±‚/å“åº”æ ¼å¼

#### æ ‡å‡†æˆåŠŸå“åº”
```json
{
  "code": 200,
  "message": "Success",
  "data": {
    "id": "uuid",
    "name": "å¼ ä¸‰",
    ...
  }
}
```

#### æ ‡å‡†é”™è¯¯å“åº”
```json
{
  "detail": {
    "code": "USAGE_LIMIT_EXCEEDED",
    "message": "å…è´¹ç”¨æˆ·æœ€å¤šåˆ›å»º5ä¸ªè§’è‰²",
    "limit_type": "character_count",
    "current": 5,
    "limit": 5
  }
}
```

#### SSE å“åº”æ ¼å¼
```
event: thinking
data: {"thinking": "æ­£åœ¨åˆ†æ..."}

data: {"content": {"text": "ä½ å¥½ï¼"}, "partial": true}
data: {"content": {"text": "ä½ å¥½ï¼æˆ‘æ˜¯..."}, "partial": true}
data: {"content": {"text": "ä½ å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹ã€‚"}, "partial": false}

data: [DONE]
```

---

## ğŸ’¬ SSE èŠå¤©åè®®

### SSE äº‹ä»¶ç±»å‹

| äº‹ä»¶ç±»å‹ | è¯´æ˜ | æ•°æ®æ ¼å¼ |
|---------|------|---------|
| `message` (é»˜è®¤) | AI å›å¤å†…å®¹ | `{"content": {"text": "..."}, "partial": true/false}` |
| `thinking` | AI æ€è€ƒè¿‡ç¨‹ | `{"thinking": "..."}` |
| `function_response` | å‡½æ•°è°ƒç”¨ç»“æœ | `{"function_response": {...}}` |
| `refresh_characters` | åˆ·æ–°è§’è‰²åˆ—è¡¨ | `{"refresh_characters": "true", "character_id": "..."}` |
| `refresh_reports` | åˆ·æ–°æŠ¥å‘Šåˆ—è¡¨ | `{"refresh_reports": "true"}` |
| `limit_reached` | è¾¾åˆ°é…é¢é™åˆ¶ | `{"message": "...", "current": 5, "limit": 5}` |

### å‰ç«¯ SSE å®¢æˆ·ç«¯å®ç°

```typescript
// hooks/use-chat-sse.ts
export function useChatSSE(options: UseChatSSEOptions) {
  const sendMessage = async (message: string, mode: string) => {
    // 1. å‘èµ· SSE è¯·æ±‚
    const response = await fetch(`${API_BASE_URL}/api/chat/v1`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`,
        'Accept': 'text/event-stream'  // ğŸ¯ å…³é”®: å£°æ˜æ¥å— SSE
      },
      body: JSON.stringify({
        message,
        session_id: sessionId,
        mode,
        stream: true
      })
    })

    // 2. è¯»å–æµ
    const reader = response.body?.getReader()
    const decoder = new TextDecoder()
    let buffer = ""
    let currentEvent = "message"  // é»˜è®¤äº‹ä»¶ç±»å‹

    while (true) {
      const { done, value } = await reader.read()
      if (done) break

      // è§£ç æ•°æ®
      buffer += decoder.decode(value, { stream: true })
      const lines = buffer.split("\n")
      buffer = lines.pop() || ""

      for (const line of lines) {
        // è§£æäº‹ä»¶ç±»å‹
        if (line.startsWith("event: ")) {
          currentEvent = line.slice(7).trim()
          continue
        }

        // è§£ææ•°æ®
        if (line.startsWith("data: ")) {
          const jsonData = line.slice(6)
          if (jsonData.trim() === "") continue
          if (jsonData.trim() === "[DONE]") break

          const data = JSON.parse(jsonData)

          // ğŸ¯ æ ¹æ®äº‹ä»¶ç±»å‹å¤„ç†
          if (currentEvent === "thinking") {
            setCurrentThinkingMessage(data.thinking)
          } else if (currentEvent === "refresh_characters") {
            options.onRefreshCharacters?.(data)
          } else if (currentEvent === "limit_reached") {
            options.onError?.({
              error: data.message,
              error_type: "usage_limit",
              retryable: false,
              resumable: false
            })
            break
          } else {
            // é»˜è®¤: å¤„ç†æ¶ˆæ¯å†…å®¹
            if (data.partial) {
              setCurrentAssistantMessage(data.content.text)
            } else {
              const finalMessage: ChatMessage = {
                id: crypto.randomUUID(),
                content: data.content.text,
                sender: "assistant",
                timestamp: new Date(),
                isComplete: true,
                thinking: currentThinkingMessage
              }
              options.onMessage?.(finalMessage)
            }
          }
        }
      }
    }
  }

  return { sendMessage, isLoading, currentAssistantMessage, currentThinkingMessage }
}
```

### åç«¯ SSE æœåŠ¡ç«¯å®ç°

```python
# app/api/v1/chat.py
from fastapi.responses import StreamingResponse

@router.post("")
async def chat(request: ChatRequest, user: Dict = Depends(get_current_user)):
    async def chat_stream_generator():
        try:
            # 1. æ£€æŸ¥é…é¢é™åˆ¶
            if limit_reached:
                yield f"event: limit_reached\n"
                yield f"data: {json.dumps({'message': '...'})}\n\n"
                return

            # 2. è°ƒç”¨æœåŠ¡å±‚
            chat_service = await get_chat_service()
            
            async for response in chat_service.process_chat_request(...):
                # 3. æ ¹æ®å“åº”ç±»å‹å‘é€ä¸åŒäº‹ä»¶
                if response.event_type == "thinking":
                    yield f"event: thinking\n"
                    yield f"data: {json.dumps({'thinking': response.content})}\n\n"
                
                elif response.event_type == "refresh_characters":
                    yield f"event: refresh_characters\n"
                    yield f"data: {json.dumps(response.content)}\n\n"
                
                else:
                    # é»˜è®¤: æ¶ˆæ¯å†…å®¹
                    yield f"data: {json.dumps({
                        'content': response.content,
                        'partial': response.partial
                    })}\n\n"

        except Exception as e:
            # 4. é”™è¯¯å¤„ç†
            yield f"data: {json.dumps({
                'content': {'error': str(e), 'error_type': '...'},
                'partial': False
            })}\n\n"
        
        finally:
            # 5. å‘é€å®Œæˆæ ‡è®°
            yield "data: [DONE]\n\n"

    return StreamingResponse(
        chat_stream_generator(),
        media_type="text/event-stream",
        headers={
            "Cache-Control": "no-cache",
            "Connection": "keep-alive",
            "X-Accel-Buffering": "no"
        }
    )
```

---

## ğŸ” è®¤è¯æµç¨‹

### å®Œæ•´è®¤è¯æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·ç™»å½•   â”‚
â”‚  (å‰ç«¯)     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend (authOperations.signIn)     â”‚
â”‚                                       â”‚
â”‚ const { data, error } = await        â”‚
â”‚   supabase.auth.signInWithPassword({ â”‚
â”‚     email,                            â”‚
â”‚     password                          â”‚
â”‚   })                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Supabase Auth Service                â”‚
â”‚                                       â”‚
â”‚ 1. éªŒè¯ç”¨æˆ·åå¯†ç                     â”‚
â”‚ 2. ç”Ÿæˆ JWT Token                    â”‚
â”‚    - access_token (çŸ­æœŸ)             â”‚
â”‚    - refresh_token (é•¿æœŸ)            â”‚
â”‚ 3. è¿”å› Token å’Œç”¨æˆ·ä¿¡æ¯             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend (è‡ªåŠ¨å­˜å‚¨)                   â”‚
â”‚                                       â”‚
â”‚ - Token å­˜å‚¨åœ¨ localStorage          â”‚
â”‚ - Supabase Client è‡ªåŠ¨ç®¡ç†           â”‚
â”‚ - è‡ªåŠ¨åˆ·æ–° Token                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åç»­ API è¯·æ±‚                         â”‚
â”‚                                       â”‚
â”‚ fetch(`${API_BASE_URL}/...`, {       â”‚
â”‚   headers: {                         â”‚
â”‚     'Authorization': `Bearer ${token}`â”‚
â”‚   }                                   â”‚
â”‚ })                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Backend (get_current_user)           â”‚
â”‚                                       â”‚
â”‚ 1. æå– Token                        â”‚
â”‚ 2. éªŒè¯ç­¾å (JWT Secret)             â”‚
â”‚ 3. æ£€æŸ¥è¿‡æœŸæ—¶é—´                      â”‚
â”‚ 4. è¿”å›ç”¨æˆ·ä¿¡æ¯                      â”‚
â”‚    {                                  â”‚
â”‚      "id": "uuid",                   â”‚
â”‚      "email": "user@example.com"     â”‚
â”‚    }                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å‰ç«¯è®¤è¯å·¥å…·

```typescript
// lib/supabase/auth.ts
export const authOperations = {
  // ç™»å½•
  async signIn(email: string, password: string) {
    const { data, error } = await supabase.auth.signInWithPassword({
      email,
      password
    })
    
    if (error) throw error
    return data
  },

  // æ³¨å†Œ
  async signUp(email: string, password: string, username: string) {
    const { data, error } = await supabase.auth.signUp({
      email,
      password,
      options: {
        data: { username }
      }
    })
    
    if (error) throw error
    return data
  },

  // ç™»å‡º
  async signOut() {
    const { error } = await supabase.auth.signOut()
    if (error) throw error
  },

  // è·å–å½“å‰ç”¨æˆ·
  async getCurrentUser() {
    const { data: { user } } = await supabase.auth.getUser()
    return user
  },

  // è·å– Access Token
  async getAccessToken() {
    const { data: { session } } = await supabase.auth.getSession()
    return session?.access_token
  }
}
```

### åç«¯è®¤è¯ä¸­é—´ä»¶

```python
# app/utils/auth.py
import jwt
from fastapi import Header, HTTPException

async def get_current_user(authorization: str = Header(...)) -> Dict[str, Any]:
    """ä» JWT Token è·å–å½“å‰ç”¨æˆ·"""
    try:
        # 1. æå– Token
        if not authorization.startswith("Bearer "):
            raise HTTPException(401, "Invalid authorization header")
        
        token = authorization.replace("Bearer ", "")
        
        # 2. éªŒè¯ Token
        payload = jwt.decode(
            token,
            settings.supabase_jwt_secret,
            algorithms=["HS256"],
            audience="authenticated"
        )
        
        # 3. è¿”å›ç”¨æˆ·ä¿¡æ¯
        return {
            "id": payload["sub"],
            "email": payload.get("email"),
            "role": payload.get("role", "authenticated")
        }
        
    except jwt.ExpiredSignatureError:
        raise HTTPException(401, "Token expired")
    except jwt.InvalidTokenError:
        raise HTTPException(401, "Invalid token")
```

---

## ğŸ“š å…±äº«èµ„æº

### å…±äº«èµ„æºç»“æ„

```
XWANAI_frontend/shared/
â”œâ”€â”€ .definitionrc          # æ•°æ®åº“å®šä¹‰ (Master)
â”œâ”€â”€ openapi.json           # API è§„èŒƒ (Master)
â””â”€â”€ chat-flow.md           # èŠå¤©åè®® (Master)

XWANAI_backend/
â”œâ”€â”€ .definitionrc â†’ ../XWANAI_frontend/shared/.definitionrc  (symlink)
â”œâ”€â”€ openapi.json â†’ ../XWANAI_frontend/shared/openapi.json   (symlink)
â””â”€â”€ chat-flow.md â†’ ../XWANAI_frontend/shared/chat-flow.md   (symlink)
```

### 1. æ•°æ®åº“å®šä¹‰ (`.definitionrc`)

**ç”¨é€”**: ç»Ÿä¸€å‰åç«¯çš„æ•°æ®åº“ Schema ç†è§£

**å†…å®¹**:
- æ‰€æœ‰è¡¨çš„ç»“æ„å®šä¹‰
- ç´¢å¼•å’Œçº¦æŸ
- RPC å‡½æ•°ç­¾å
- ä½¿ç”¨ç¤ºä¾‹

**æ›´æ–°æ—¶æœº**:
- âœ… åˆ›å»ºæˆ–ä¿®æ”¹æ•°æ®åº“è¡¨
- âœ… æ·»åŠ æˆ–ä¿®æ”¹ RPC å‡½æ•°
- âœ… ä¿®æ”¹ç´¢å¼•æˆ–çº¦æŸ

**å‰ç«¯ä½¿ç”¨**:
```typescript
// å‰ç«¯é€šè¿‡ Supabase Client è‡ªåŠ¨è·å–ç±»å‹
import { Tables } from "@/lib/supabase/types"

type Character = Tables<"characters">
```

**åç«¯ä½¿ç”¨**:
```python
# åç«¯å‚è€ƒ .definitionrc ç¡®ä¿ RPC è°ƒç”¨æ­£ç¡®
result = await client.rpc('is_premium_user', {
    'target_user_id': user_id  # å‚æ•°åå¿…é¡»åŒ¹é…
})
```

### 2. API è§„èŒƒ (`openapi.json`)

**ç”¨é€”**: å®šä¹‰å‰åç«¯ API å¥‘çº¦

**ç”Ÿæˆæ–¹å¼**:
```bash
# åç«¯è¿è¡Œåè®¿é—®
curl http://localhost:8000/openapi.json > ../XWANAI_frontend/shared/openapi.json
```

**å‰ç«¯ä½¿ç”¨**:
```typescript
// å‚è€ƒ openapi.json ç¡®ä¿è¯·æ±‚æ ¼å¼æ­£ç¡®
const response = await fetch(`${API_BASE_URL}/api/character/v1`, {
  method: 'POST',
  body: JSON.stringify({
    name: "å¼ ä¸‰",       // âœ… å¿…å¡«
    gender: "male",     // âœ… å¿…å¡«
    birth_time: "...",  // âœ… å¿…å¡«
    description: "..."  // âœ… å¯é€‰
  })
})
```

### 3. èŠå¤©åè®® (`chat-flow.md`)

**ç”¨é€”**: å®šä¹‰ SSE èŠå¤©çš„è¯¦ç»†åè®®

**å†…å®¹**:
- SSE äº‹ä»¶ç±»å‹
- æ¶ˆæ¯æ ¼å¼
- é”™è¯¯å¤„ç†
- ç‰¹æ®Šå†…å®¹ç±»å‹ (`vis-paipan`)

**å‰åç«¯åä½œ**:
```
Frontend                    Backend
   â”‚                           â”‚
   â”œâ”€ å‘é€æ¶ˆæ¯                 â”‚
   â”‚  POST /api/chat/v1        â”‚
   â”‚  {message, mode, ...}     â”‚
   â”‚                           â”‚
   â”‚                       â† â”€â”¤ è¿”å› SSE æµ
   â”‚                           â”‚
   â”œâ”€ event: thinking          â”‚
   â”‚  data: {...}              â”‚
   â”‚                           â”‚
   â”œâ”€ data: {...}  (partial)   â”‚
   â”œâ”€ data: {...}  (partial)   â”‚
   â”‚                           â”‚
   â”œâ”€ event: refresh_charactersâ”‚
   â”‚  data: {...}              â”‚
   â”‚                           â”‚
   â”œâ”€ data: {...}  (final)     â”‚
   â”‚                           â”‚
   â”œâ”€ data: [DONE]             â”‚
```

---

## ğŸ”„ æ ¸å¿ƒä¸šåŠ¡æµç¨‹

### 1. è§’è‰²åˆ›å»ºå®Œæ•´æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ç”¨æˆ·å¡«å†™è§’è‰²ä¿¡æ¯                  â”‚
â”‚    - å§“åã€æ€§åˆ«ã€å‡ºç”Ÿæ—¶é—´            â”‚
â”‚    - MBTIã€æè¿°ã€æ ‡ç­¾                â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. å‰ç«¯éªŒè¯                          â”‚
â”‚    - å¿…å¡«å­—æ®µæ£€æŸ¥                    â”‚
â”‚    - æ ¼å¼éªŒè¯                        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. å‰ç«¯å‘é€ API è¯·æ±‚                 â”‚
â”‚    POST /api/character/v1            â”‚
â”‚    {                                  â”‚
â”‚      name, gender, birth_time,       â”‚
â”‚      longitude, birthplace, ...      â”‚
â”‚    }                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. åç«¯: è®¤è¯ + é…é¢æ£€æŸ¥             â”‚
â”‚    - éªŒè¯ JWT Token                  â”‚
â”‚    - æ£€æŸ¥è§’è‰²æ•°é‡é™åˆ¶                â”‚
â”‚    - å…è´¹ç”¨æˆ·: æœ€å¤š5ä¸ª               â”‚
â”‚    - ä¼šå‘˜: æ— é™åˆ¶                    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. åç«¯: è®¡ç®—å…«å­—                    â”‚
â”‚    BaziCalculator.calculate_bazi(    â”‚
â”‚      birth_time, longitude           â”‚
â”‚    )                                  â”‚
â”‚    â†’ ç”Ÿæˆ paipan æ•°æ®                â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. åç«¯: ä¿å­˜åˆ°æ•°æ®åº“                â”‚
â”‚    INSERT INTO characters            â”‚
â”‚    {                                  â”‚
â”‚      id, auth_id, name, paipan,      â”‚
â”‚      is_report_ready: false, ...     â”‚
â”‚    }                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. åç«¯: åå°ä»»åŠ¡ (ç”ŸæˆæŠ¥å‘Š)         â”‚
â”‚    bg_task.add_task(                 â”‚
â”‚      generate_reports,               â”‚
â”‚      character_id                    â”‚
â”‚    )                                  â”‚
â”‚                                       â”‚
â”‚    å¼‚æ­¥ç”Ÿæˆ:                         â”‚
â”‚    - basic (æ ¸å¿ƒè¦ç´ æ¡£æ¡ˆ)            â”‚
â”‚    - personal (æ€§æ ¼åˆ†æ)             â”‚
â”‚    - luck (äººç”Ÿå¤šå…ƒæ£±é•œ)             â”‚
â”‚    - achievement (äººç”Ÿæˆå°±)          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. åç«¯: è¿”å›è§’è‰²æ•°æ®                â”‚
â”‚    {                                  â”‚
â”‚      id, name, paipan,               â”‚
â”‚      is_report_ready: false,         â”‚
â”‚      processing_status: "processing" â”‚
â”‚    }                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. å‰ç«¯: æ¥æ”¶å“åº”                    â”‚
â”‚    - åˆ·æ–° React Query ç¼“å­˜           â”‚
â”‚    - è·³è½¬åˆ°è§’è‰²è¯¦æƒ…é¡µ                â”‚
â”‚    - æ˜¾ç¤º "æŠ¥å‘Šç”Ÿæˆä¸­..." æç¤º       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 10. (åå°) æŠ¥å‘Šç”Ÿæˆå®Œæˆ              â”‚
â”‚     UPDATE characters                â”‚
â”‚     SET                               â”‚
â”‚       reports = {...},               â”‚
â”‚       is_report_ready = true,        â”‚
â”‚       processing_status = "completed"â”‚
â”‚     WHERE id = character_id          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 11. å‰ç«¯: è½®è¯¢æˆ–åˆ·æ–°                 â”‚
â”‚     - ç”¨æˆ·åˆ·æ–°é¡µé¢                   â”‚
â”‚     - æˆ–å‰ç«¯å®šæ—¶æŸ¥è¯¢çŠ¶æ€             â”‚
â”‚     â†’ çœ‹åˆ°æŠ¥å‘Šå·²ç”Ÿæˆ                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. AI å¯¹è¯å®Œæ•´æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ç”¨æˆ·è¾“å…¥æ¶ˆæ¯å¹¶å‘é€                â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. å‰ç«¯: useChatSSE Hook             â”‚
â”‚    sendMessage(message, mode)        â”‚
â”‚    â†’ ç«‹å³æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯                â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. å‰ç«¯: å‘èµ· SSE è¯·æ±‚               â”‚
â”‚    POST /api/chat/v1                 â”‚
â”‚    Accept: text/event-stream         â”‚
â”‚    {                                  â”‚
â”‚      message, session_id, mode       â”‚
â”‚    }                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. åç«¯: è®¤è¯ + é…é¢æ£€æŸ¥             â”‚
â”‚    - éªŒè¯ JWT Token                  â”‚
â”‚    - æ£€æŸ¥å¯¹è¯å›åˆé™åˆ¶                â”‚
â”‚    - å…è´¹ç”¨æˆ·: æ¯ä¼šè¯5å›åˆ           â”‚
â”‚    - ä¼šå‘˜: æ— é™åˆ¶                    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. åç«¯: åŠ è½½ Session å’Œç¼“å­˜         â”‚
â”‚    - ä» sessions.state è¯»å–:         â”‚
â”‚      * character_cache (è§’è‰²æ•°æ®)    â”‚
â”‚      * mode (å¯¹è¯æ¨¡å¼)               â”‚
â”‚      * turn_count (å½“å‰å›åˆæ•°)       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. åç«¯: æ„å»º AI Prompt              â”‚
â”‚    - åŠ è½½å¯¹è¯å†å²                    â”‚
â”‚    - åŠ è½½è§’è‰²ä¿¡æ¯å’Œå…«å­—æ•°æ®          â”‚
â”‚    - æ„å»º System Instruction         â”‚
â”‚    - æ„å»ºç”¨æˆ·æ¶ˆæ¯                    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. åç«¯: è°ƒç”¨ Gemini AI (æµå¼)      â”‚
â”‚    async for chunk in                â”‚
â”‚      model.stream_generate_content():â”‚
â”‚                                       â”‚
â”‚    # æµå¼å‘é€ thinking               â”‚
â”‚    yield "event: thinking\n"         â”‚
â”‚    yield f"data: {{...}}\n\n"        â”‚
â”‚                                       â”‚
â”‚    # æµå¼å‘é€å›å¤                    â”‚
â”‚    yield f"data: {{...}}\n\n"        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. å‰ç«¯: æ¥æ”¶ SSE æµ                 â”‚
â”‚    - è§£æ SSE äº‹ä»¶                   â”‚
â”‚    - æ›´æ–° UI (å®æ—¶æ˜¾ç¤º)              â”‚
â”‚      * Thinking éƒ¨åˆ†                 â”‚
â”‚      * AI å›å¤ (æ‰“å­—æœºæ•ˆæœ)          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. åç«¯: AI å“åº”å®Œæˆ                 â”‚
â”‚    - ä¿å­˜ AI å›å¤åˆ° events è¡¨        â”‚
â”‚    - æ›´æ–° session.state.turn_count   â”‚
â”‚    - æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ›å»ºè§’è‰²            â”‚
â”‚      (å¦‚æœ mode æ˜¯ create_character) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 10. åç«¯: å‘é€ç‰¹æ®Šäº‹ä»¶ (å¦‚æœéœ€è¦)    â”‚
â”‚     # è§’è‰²åˆ›å»ºæˆåŠŸ                   â”‚
â”‚     yield "event: refresh_characters"â”‚
â”‚     yield f"data: {{...}}\n\n"       â”‚
â”‚                                       â”‚
â”‚     # å‘é€å®Œæˆæ ‡è®°                   â”‚
â”‚     yield "data: [DONE]\n\n"         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 11. å‰ç«¯: å¤„ç†å®Œæˆ                   â”‚
â”‚     - ä¿å­˜å®Œæ•´æ¶ˆæ¯åˆ° state           â”‚
â”‚     - å¦‚æœæ”¶åˆ° refresh_characters:   â”‚
â”‚       åˆ·æ–°è§’è‰²åˆ—è¡¨ç¼“å­˜               â”‚
â”‚     - æ»šåŠ¨åˆ°åº•éƒ¨                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. è®¢é˜…æ”¯ä»˜æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ç”¨æˆ·ç‚¹å‡» "å‡çº§ä¼šå‘˜"               â”‚
â”‚    - é€‰æ‹©å¥—é¤ (æœˆä»˜/å¹´ä»˜)            â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. å‰ç«¯: åˆ›å»º Checkout Session       â”‚
â”‚    POST /api/stripe/v1/checkout      â”‚
â”‚    {                                  â”‚
â”‚      tier: "monthly" | "yearly",     â”‚
â”‚      success_url: "...",             â”‚
â”‚      cancel_url: "..."               â”‚
â”‚    }                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. åç«¯: è°ƒç”¨ Stripe API             â”‚
â”‚    stripe.checkout.Session.create({  â”‚
â”‚      customer_email,                 â”‚
â”‚      line_items: [{ price_id, ... }],â”‚
â”‚      mode: 'subscription',           â”‚
â”‚      metadata: { user_id }           â”‚
â”‚    })                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. åç«¯: è¿”å› Checkout URL           â”‚
â”‚    {                                  â”‚
â”‚      checkout_url: "https://..."     â”‚
â”‚    }                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. å‰ç«¯: è·³è½¬åˆ° Stripe Checkout      â”‚
â”‚    window.location.href = checkout_urlâ”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. ç”¨æˆ·åœ¨ Stripe é¡µé¢å®Œæˆæ”¯ä»˜        â”‚
â”‚    - è¾“å…¥ä¿¡ç”¨å¡ä¿¡æ¯                  â”‚
â”‚    - ç¡®è®¤è®¢é˜…                        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. Stripe: å‘é€ Webhook äº‹ä»¶         â”‚
â”‚    POST /api/stripe/v1/webhook       â”‚
â”‚    {                                  â”‚
â”‚      type: "checkout.session.        â”‚
â”‚             completed",               â”‚
â”‚      data: { ... }                   â”‚
â”‚    }                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. åç«¯: å¤„ç† Webhook                â”‚
â”‚    - éªŒè¯ç­¾å                        â”‚
â”‚    - æå– user_id ä» metadata        â”‚
â”‚    - æ›´æ–° profiles è¡¨:               â”‚
â”‚      * subscription_status = "active"â”‚
â”‚      * subscription_tier = "premium" â”‚
â”‚      * subscription_end_date = ...   â”‚
â”‚      * stripe_customer_id = ...      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. Stripe: é‡å®šå‘å›å‰ç«¯              â”‚
â”‚    â†’ success_url                     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 10. å‰ç«¯: æ˜¾ç¤ºæˆåŠŸé¡µé¢               â”‚
â”‚     /subscription/success            â”‚
â”‚     - åˆ·æ–°ç”¨æˆ·èµ„æ–™                   â”‚
â”‚     - æ˜¾ç¤ºä¼šå‘˜ç‰¹æƒ                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âŒ é”™è¯¯å¤„ç†

### é”™è¯¯ç±»å‹å’Œå¤„ç†ç­–ç•¥

| é”™è¯¯ç±»å‹ | HTTP çŠ¶æ€ç  | å‰ç«¯å¤„ç† | åç«¯å¤„ç† |
|---------|-------------|----------|----------|
| è®¤è¯å¤±è´¥ | 401 | è·³è½¬åˆ°ç™»å½•é¡µ | è¿”å› 401 + error message |
| æƒé™ä¸è¶³ | 403 | æ˜¾ç¤ºé”™è¯¯æç¤º + å‡çº§å¼•å¯¼ | è¿”å› 403 + limit info |
| èµ„æºä¸å­˜åœ¨ | 404 | æ˜¾ç¤º "æœªæ‰¾åˆ°" | è¿”å› 404 + error message |
| é…é¢è¶…é™ | 403 | æ˜¾ç¤ºé…é¢æç¤º + å‡çº§æŒ‰é’® | è¿”å› UsageLimitError |
| æœåŠ¡å™¨é”™è¯¯ | 500 | æ˜¾ç¤ºé€šç”¨é”™è¯¯ + é‡è¯•æŒ‰é’® | è®°å½•æ—¥å¿— + è¿”å› 500 |
| AI è°ƒç”¨å¤±è´¥ | 500 | æ˜¾ç¤ºé”™è¯¯ + é‡è¯•æŒ‰é’® | é™çº§åˆ°å¤‡ç”¨ AI æˆ–è¿”å›é”™è¯¯ |

### å‰ç«¯é”™è¯¯å¤„ç†ç¤ºä¾‹

```typescript
// âœ… ç»Ÿä¸€çš„é”™è¯¯å¤„ç†
try {
  const response = await apiClient.createCharacter(characterData)
  toast.success("è§’è‰²åˆ›å»ºæˆåŠŸï¼")
  router.push(`/character/info?id=${response.data.id}`)
} catch (error: any) {
  logger.error("Failed to create character", { error })

  // å¤„ç†ä¸åŒç±»å‹çš„é”™è¯¯
  if (error.status === 401) {
    toast.error("è¯·å…ˆç™»å½•")
    router.push("/login")
  } else if (error.status === 403) {
    const detail = error.detail
    
    if (detail.code === "USAGE_LIMIT_EXCEEDED") {
      // é…é¢è¶…é™
      toast.error(detail.message, {
        description: `å½“å‰: ${detail.current}/${detail.limit}`,
        action: {
          label: "å‡çº§ä¼šå‘˜",
          onClick: () => router.push("/subscription")
        }
      })
    } else {
      toast.error("æƒé™ä¸è¶³")
    }
  } else {
    toast.error("åˆ›å»ºå¤±è´¥ï¼Œè¯·é‡è¯•")
  }
}
```

### åç«¯é”™è¯¯å¤„ç†ç¤ºä¾‹

```python
# app/utils/exception.py
from fastapi import Request
from fastapi.responses import JSONResponse

async def usage_limit_exception_handler(request: Request, exc: UsageLimitError):
    """é…é¢é™åˆ¶å¼‚å¸¸å¤„ç†å™¨"""
    return JSONResponse(
        status_code=403,
        content={
            "detail": {
                "code": "USAGE_LIMIT_EXCEEDED",
                "message": exc.message,
                "limit_type": exc.limit_type,
                "current": exc.current,
                "limit": exc.limit
            }
        }
    )

# æ³¨å†Œå¼‚å¸¸å¤„ç†å™¨
app.add_exception_handler(UsageLimitError, usage_limit_exception_handler)
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–

### 1. ç¼“å­˜ç­–ç•¥å¯¹æ¯”

| å±‚çº§ | å‰ç«¯ç¼“å­˜ | åç«¯ç¼“å­˜ |
|------|----------|----------|
| **React Query** | 1åˆ†é’Ÿ staleTime | N/A |
| **MobX Store** | ä¼šè¯æœŸé—´ | N/A |
| **Session State** | N/A | æ•°æ®åº“ JSONB (æ°¸ä¹…) |
| **Supabase RLS** | N/A | PostgreSQL æŸ¥è¯¢ç¼“å­˜ |

### 2. æ•°æ®é¢„åŠ è½½ç­–ç•¥

**å‰ç«¯é¢„åŠ è½½**:
```typescript
// âœ… é¢„åŠ è½½å…³é”®æ•°æ®
const HomePage = () => {
  const userId = Store.user.userId

  // å¹¶å‘é¢„åŠ è½½
  const { data: characters } = useUserCharacters(userId)
  const { data: sessions } = useUserSessions(userId)
  const { data: usageStats } = useUsageStats(userId)

  // é¢„å–ä¸‹ä¸€é¡µæ•°æ®
  useEffect(() => {
    if (characters && characters.length > 0) {
      queryClient.prefetchQuery({
        queryKey: queryKeys.characterById(characters[0].id)
      })
    }
  }, [characters])

  return (...)
}
```

**åç«¯ç¼“å­˜ç­–ç•¥**:
```python
# âœ… ä½¿ç”¨ session.state ç¼“å­˜
async def get_character_from_session(session_id: str):
    # 1. å°è¯•ä» session.state è¯»å–ç¼“å­˜
    result = await client.table('sessions').select('state').eq('id', session_id).single().execute()
    character_cache = result.data.get('state', {}).get('character_cache')
    
    if character_cache:
        logger.info(f"âœ… [ç¼“å­˜å‘½ä¸­] ä» session.state è¯»å–è§’è‰²æ•°æ®")
        return character_cache
    
    # 2. ç¼“å­˜æœªå‘½ä¸­ï¼Œä»æ•°æ®åº“æŸ¥è¯¢
    character = await client.table('characters').select('*').eq('id', character_id).single().execute()
    
    # 3. æ›´æ–°ç¼“å­˜
    await update_session_cache(session_id, character.data)
    
    return character.data
```

### 3. æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

```sql
-- âœ… æ·»åŠ å¤åˆç´¢å¼•
CREATE INDEX idx_characters_auth_id_created_at 
ON characters(auth_id, created_at DESC);

-- âœ… ä½¿ç”¨ JOIN å‡å°‘æŸ¥è¯¢æ¬¡æ•°
SELECT 
  s.*,
  c.name AS character_name,
  c.avatar_id
FROM sessions s
LEFT JOIN characters c ON c.id = ANY(s.character_ids)
WHERE s.user_id = 'user_uuid'
ORDER BY s.update_time DESC
LIMIT 20;

-- âœ… ä½¿ç”¨ RPC å‡½æ•°å°è£…å¤æ‚æŸ¥è¯¢
CREATE FUNCTION get_user_dashboard(user_id UUID)
RETURNS JSON AS $$
  SELECT json_build_object(
    'characters', (SELECT COUNT(*) FROM characters WHERE auth_id = user_id),
    'sessions', (SELECT COUNT(*) FROM sessions WHERE user_id = user_id),
    'is_premium', is_premium_user(user_id)
  )
$$ LANGUAGE sql;
```

---

## ğŸ¤ å¼€å‘åä½œ

### å·¥ä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. éœ€æ±‚è®¨è®º                          â”‚
â”‚    - ç¡®å®šåŠŸèƒ½éœ€æ±‚                    â”‚
â”‚    - è®¾è®¡ API æ¥å£                   â”‚
â”‚    - æ›´æ–°å…±äº«èµ„æº                    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. æ›´æ–°å…±äº«èµ„æº                      â”‚
â”‚    - æ›´æ–° openapi.json (API è§„èŒƒ)    â”‚
â”‚    - æ›´æ–° .definitionrc (æ•°æ®åº“)     â”‚
â”‚    - æ›´æ–° chat-flow.md (å¦‚æ¶‰åŠèŠå¤©)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. åç«¯å¼€å‘                          â”‚
â”‚    - å®ç° API æ¥å£                   â”‚
â”‚    - ç¼–å†™å•å…ƒæµ‹è¯•                    â”‚
â”‚    - æ›´æ–° OpenAPI æ–‡æ¡£               â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. å‰ç«¯å¼€å‘                          â”‚
â”‚    - è°ƒç”¨åç«¯ API                    â”‚
â”‚    - å®ç° UI/UX                      â”‚
â”‚    - æ·»åŠ é”™è¯¯å¤„ç†                    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. è”è°ƒæµ‹è¯•                          â”‚
â”‚    - æµ‹è¯• API é›†æˆ                   â”‚
â”‚    - æµ‹è¯•é”™è¯¯åœºæ™¯                    â”‚
â”‚    - æ€§èƒ½æµ‹è¯•                        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Code Review                       â”‚
â”‚    - æ£€æŸ¥ä»£ç è´¨é‡                    â”‚
â”‚    - æ£€æŸ¥é”™è¯¯å¤„ç†                    â”‚
â”‚    - æ£€æŸ¥æ€§èƒ½ä¼˜åŒ–                    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. éƒ¨ç½²ä¸Šçº¿                          â”‚
â”‚    - åç«¯éƒ¨ç½² (Docker)               â”‚
â”‚    - å‰ç«¯éƒ¨ç½² (Vercel)               â”‚
â”‚    - æ•°æ®åº“è¿ç§»                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä»£ç æäº¤è§„èŒƒ

```bash
# âœ… æäº¤æ¶ˆæ¯æ ¼å¼
<type>(<scope>): <subject>

# type:
# - feat: æ–°åŠŸèƒ½
# - fix: Bug ä¿®å¤
# - docs: æ–‡æ¡£æ›´æ–°
# - style: ä»£ç æ ¼å¼è°ƒæ•´
# - refactor: é‡æ„
# - perf: æ€§èƒ½ä¼˜åŒ–
# - test: æµ‹è¯•
# - chore: æ„å»º/å·¥å…·é“¾

# ç¤ºä¾‹:
feat(chat): æ·»åŠ  SSE æµå¼å¯¹è¯æ”¯æŒ
fix(character): ä¿®å¤è§’è‰²åˆ›å»ºé…é¢æ£€æŸ¥é€»è¾‘
docs(api): æ›´æ–° openapi.json æ–‡æ¡£
perf(database): ä¼˜åŒ–è§’è‰²åˆ—è¡¨æŸ¥è¯¢æ€§èƒ½
```

### åˆ†æ”¯ç®¡ç†ç­–ç•¥

```
main (ç”Ÿäº§åˆ†æ”¯)
  â”œâ”€ develop (å¼€å‘åˆ†æ”¯)
  â”‚   â”œâ”€ feature/chat-sse (åŠŸèƒ½åˆ†æ”¯)
  â”‚   â”œâ”€ feature/payment-stripe (åŠŸèƒ½åˆ†æ”¯)
  â”‚   â””â”€ fix/character-quota (ä¿®å¤åˆ†æ”¯)
  â””â”€ hotfix/critical-bug (ç´§æ€¥ä¿®å¤)
```

---

## ğŸ”š æ€»ç»“

æœ¬æ–‡æ¡£æ¶µç›–äº† XWANAI å‰åç«¯åä½œçš„å®Œæ•´æŒ‡å—ï¼ŒåŒ…æ‹¬:

- âœ… ç³»ç»Ÿæ¶æ„å’Œæ•°æ®æµè®¾è®¡
- âœ… API é›†æˆå’Œ SSE åè®®
- âœ… è®¤è¯æµç¨‹å’Œå®‰å…¨ç­–ç•¥
- âœ… å…±äº«èµ„æºç®¡ç†
- âœ… æ ¸å¿ƒä¸šåŠ¡æµç¨‹è¯¦è§£
- âœ… é”™è¯¯å¤„ç†å’Œæ€§èƒ½ä¼˜åŒ–
- âœ… å›¢é˜Ÿåä½œå’Œå¼€å‘è§„èŒƒ

**å…³é”®è¦ç‚¹**:
1. å‰ç«¯ä¼˜å…ˆä½¿ç”¨ Supabase Client ç›´æ¥æŸ¥è¯¢ç®€å•æ•°æ®
2. å¤æ‚ä¸šåŠ¡é€»è¾‘é€šè¿‡åç«¯ API å¤„ç†
3. SSE ç”¨äº AI å¯¹è¯çš„å®æ—¶æµå¼å“åº”
4. Session State ç”¨äºç¼“å­˜è§’è‰²å’Œå‘½ç›˜æ•°æ®
5. å…±äº«èµ„æº (`.definitionrc`, `openapi.json`, `chat-flow.md`) ä¿æŒåŒæ­¥

å¦‚éœ€æŸ¥çœ‹å…·ä½“å®ç°ç»†èŠ‚ï¼Œè¯·å‚è€ƒ:
- ã€Šå‰ç«¯å¼€å‘æ–‡æ¡£ã€‹- å‰ç«¯æ¶æ„å’Œç»„ä»¶ç³»ç»Ÿ
- ã€Šåç«¯å¼€å‘æ–‡æ¡£ã€‹- åç«¯æ¶æ„å’ŒæœåŠ¡å±‚

---

**æ–‡æ¡£ç»´æŠ¤**: è¯·åœ¨æ¶æ„å˜æ›´æ—¶åŒæ­¥æ›´æ–°æœ¬æ–‡æ¡£  
**åé¦ˆæ¸ é“**: GitHub Issues æˆ–å¼€å‘å›¢é˜Ÿå†…éƒ¨é€šé“

